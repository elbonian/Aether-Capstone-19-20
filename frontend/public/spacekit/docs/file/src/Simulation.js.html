<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Simulation.js | spacekit.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Ephem.js~Ephem.html">Ephem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/EphemPresets.js~NaturalSatellites.html">NaturalSatellites</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/KeplerParticles.js~KeplerParticles.html">KeplerParticles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Orbit.js~Orbit.html">Orbit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RotatingObject.js~RotatingObject.html">RotatingObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ShapeObject.js~ShapeObject.html">ShapeObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Simulation.js~Simulation.html">Simulation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Skybox.js~Skybox.html">Skybox</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SpaceObject.js~SpaceObject.html">SpaceObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SphereObject.js~SphereObject.html">SphereObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Stars.js~Stars.html">Stars</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/StaticParticles.js~StaticParticles.html">StaticParticles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eclipticToEquatorial_Cartesian">eclipticToEquatorial_Cartesian</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-equatorialToEcliptic_Cartesian">equatorialToEcliptic_Cartesian</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getNutationAndObliquity">getNutationAndObliquity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getObliquity">getObliquity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sphericalToCartesian">sphericalToCartesian</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getOrbitType">getOrbitType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getScaleFactor">getScaleFactor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescale">rescale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescaleArray">rescaleArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescaleNumber">rescaleNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescalePos">rescalePos</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescaleVector">rescaleVector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rescaleXYZ">rescaleXYZ</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setScaleFactor">setScaleFactor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-auToKm">auToKm</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decimalToSexagesimalDec">decimalToSexagesimalDec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decimalToSexagesimalRa">decimalToSexagesimalRa</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deg">deg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hoursToDeg">hoursToDeg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-kmToAu">kmToAu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rad">rad</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sexagesimalToDecimalDec">sexagesimalToDecimalDec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sexagesimalToDecimalRa">sexagesimalToDecimalRa</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDefaultBasePath">getDefaultBasePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getFullTextureUrl">getFullTextureUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getFullUrl">getFullUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getThreeJsTexture">getThreeJsTexture</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GM">GM</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EphemPresets">EphemPresets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-OrbitType">OrbitType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SkyboxPresets">SkyboxPresets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SpaceObjectPresets">SpaceObjectPresets</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ATMOSPHERE_SHADER_FRAGMENT">ATMOSPHERE_SHADER_FRAGMENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ATMOSPHERE_SHADER_VERTEX">ATMOSPHERE_SHADER_VERTEX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GENERIC_PARTICLE_SHADER_FRAGMENT">GENERIC_PARTICLE_SHADER_FRAGMENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GENERIC_PARTICLE_SHADER_VERTEX">GENERIC_PARTICLE_SHADER_VERTEX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RING_SHADER_FRAGMENT">RING_SHADER_FRAGMENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RING_SHADER_VERTEX">RING_SHADER_VERTEX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SPHERE_SHADER_FRAGMENT">SPHERE_SHADER_FRAGMENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SPHERE_SHADER_VERTEX">SPHERE_SHADER_VERTEX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STAR_SHADER_FRAGMENT">STAR_SHADER_FRAGMENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-STAR_SHADER_VERTEX">STAR_SHADER_VERTEX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-THREE">THREE</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Simulation.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import * as THREE from &apos;three&apos;;
import julian from &apos;julian&apos;;
import Stats from &apos;three/examples/jsm/libs/stats.module.js&apos;;
import {
  EffectComposer,
  BlendFunction,
  EffectPass,
  GodRaysEffect,
  BloomEffect,
  KernelSize,
  SMAAEffect,
  RenderPass,
} from &apos;postprocessing&apos;;

import { Camera } from &apos;./Camera&apos;;
import { KeplerParticles } from &apos;./KeplerParticles&apos;;
import { NaturalSatellites } from &apos;./EphemPresets&apos;;
import { ShapeObject } from &apos;./ShapeObject&apos;;
import { Skybox } from &apos;./Skybox&apos;;
import { SpaceObject } from &apos;./SpaceObject&apos;;
import { SphereObject } from &apos;./SphereObject&apos;;
import { StaticParticles } from &apos;./StaticParticles&apos;;
import { Stars } from &apos;./Stars&apos;;
import { getDefaultBasePath } from &apos;./util&apos;;
import { setScaleFactor, rescaleArray, rescaleNumber } from &apos;./Scale&apos;;

/**
 * The main entrypoint of a visualization.
 *
 * This class wraps a THREE.js scene, controls, skybox, etc in an animated
 * Simulation.
 *
 * @example
 * const sim = new Spacekit.Simulation(document.getElementById(&apos;my-container&apos;), {
 *  basePath: &apos;../path/to/assets&apos;,
 *  startDate: Date.now(),
 *  jd: 0.0,
 *  jdDelta: 10.0,
 *  jdPerSecond: 100.0,  // overrides jdDelta
 *  startPaused: false,
 *  unitsPerAu: 1.0,
 *  maxNumParticles: 2**16,
 *  camera: {
 *    initialPosition: [0, -10, 5],
 *    enableDrift: false,
 *  },
 *  debug: {
 *    showAxes: false,
 *    showGrid: false,
 *    showStats: false,
 *  },
 * });
 */
export class Simulation {
  /**
   * @param {HTMLElement} simulationElt The container for this simulation.
   * @param {Object} options for simulation
   * @param {String} options.basePath Path to simulation assets and data
   * @param {Date} options.startDate The start date and time for this
   * simulation.
   * @param {Number} options.jd The JD date of this simulation.
   * Defaults to 0
   * @param {Number} options.jdDelta The number of JD to add every tick of
   * the simulation.
   * @param {Number} options.jdPerSecond The number of jd to add every second.
   * Use this instead of `jdDelta` for constant motion that does not vary with
   * framerate.  Defaults to 100.
   * @param {Number} options.unitsPerAu The number of &quot;position&quot; units in the
   * simulation that represent an AU. This is an optional setting that you may
   * use if the default (1 unit = 1 AU) is too small for your simulation (e.g.
   * if you are representing a planetary system). Depending on your graphics
   * card, you may begin to notice inaccuracies at fractional scales of GL
   * units, so it becomes necessary to scale the whole visualization.  Defaults
   * to 1.0.
   * @param {boolean} options.startPaused Whether the simulation should start
   * in a paused state.
   * @param {Number} options.maxNumParticles The maximum number of particles in
   * the visualization. Try choosing a number that is larger than your
   * particles, but not too much larger. It&apos;s usually good enough to choose the
   * next highest power of 2. If you&apos;re not showing many particles (tens of
   * thousands+), you don&apos;t need to worry about this.
   * @param {String} options.particleTextureUrl The texture for the default
   * particle system.
   * @param {Number} options.particleDefaultSize The default size for the
   * particle system.
   * @param {Object} options.camera Options for camera
   * @param {Array.&lt;Number&gt;} options.camera.initialPosition Initial X, Y, Z
   * coordinates of the camera. Defaults to [0, -10, 5].
   * @param {boolean} options.camera.enableDrift Set true to have the camera
   * float around slightly. False by default.
   * @param {Object} options.debug Options dictating debug state.
   * @param {boolean} options.debug.showAxes Show X, Y, and Z axes
   * @param {boolean} options.debug.showGrid Show grid on XY plane
   * @param {boolean} options.debug.showStats Show FPS and other stats
   * (requires stats.js).
   */
  constructor(simulationElt, options) {
    this._simulationElt = simulationElt;
    this._options = options || {};
    this._options.basePath = this._options.basePath || getDefaultBasePath();

    this._jd =
      typeof this._options.jd === &apos;undefined&apos;
        ? Number(julian(this._options.startDate)) || 0
        : this._options.jd;
    this._jdDelta = this._options.jdDelta;
    this._jdPerSecond = this._options.jdPerSecond || 100;
    this._isPaused = options.startPaused || false;
    this.onTick = null;

    this._enableCameraDrift = false;
    this._cameraDefaultPos = rescaleArray([0, -10, 5]);
    if (this._options.camera) {
      this._enableCameraDrift = !!this._options.camera.enableDrift;
      if (this._options.camera.initialPosition) {
        this._cameraDefaultPos = rescaleArray(
          this._options.camera.initialPosition,
        );
      }
    }

    this._camera = null;
    this._isUsingLightSources = false;
    this._lightPosition = null;

    this._subscribedObjects = {};
    this._particles = null;

    // stats.js panel
    this._stats = null;
    this._fps = 1;
    this._lastUpdatedTime = Date.now();

    // Rendering
    this._renderEnabled = true;
    this.animate = this.animate.bind(this);

    this._scene = null;
    this._renderer = null;
    this._composer = null;

    this.init();
    this.animate();
  }

  /**
   * @private
   */
  init() {
    this.initRenderer();

    // Misc
    // This makes controls.lookAt and other objects treat the positive Z axis
    // as &quot;up&quot; direction.
    THREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1);

    // Scale
    if (this._options.unitsPerAu) {
      setScaleFactor(this._options.unitsPerAu);
    }

    // Scene
    const scene = new THREE.Scene();
    this._scene = scene;

    // Camera
    const camera = new Camera(this.getContext());
    camera
      .get3jsCamera()
      .position.set(
        this._cameraDefaultPos[0],
        this._cameraDefaultPos[1],
        this._cameraDefaultPos[2],
      );
    window.cam = camera.get3jsCamera();
    this._camera = camera;

    // Events
    this._simulationElt.onmousedown = this._simulationElt.ontouchstart = () =&gt; {
      // When user begins interacting with the visualization, disable camera
      // drift.
      this._enableCameraDrift = false;
    };

    // Helper
    if (this._options.debug) {
      if (this._options.debug.showGrid) {
        const gridHelper = new THREE.GridHelper();
        gridHelper.geometry.rotateX(Math.PI / 2);
        this._scene.add(gridHelper);
      }
      if (this._options.debug.showAxes) {
        this._scene.add(new THREE.AxesHelper(0.5));
      }
      if (this._options.debug.showStats) {
        this._stats = new Stats();
        this._stats.showPanel(0);
        this._simulationElt.appendChild(this._stats.dom);
      }
    }

    // Orbit particle system must be initialized after scene is created.
    this._particles = new KeplerParticles(
      {
        textureUrl:
          this._options.particleTextureUrl ||
          &apos;{{assets}}/sprites/smallparticle.png&apos;,
        jd: this._jd,
        maxNumParticles: this._options.maxNumParticles,
        defaultSize: this._options.particleDefaultSize,
      },
      this,
    );

    // Set up effect composer, etc.
    this.initPasses();
  }

  /**
   * @private
   */
  initRenderer() {
    const renderer = new THREE.WebGLRenderer({
      antialias: true,
      //logarithmicDepthBuffer: true,
    });
    renderer.gammaInput = true;
    renderer.gammaOutput = true;
    console.info(
      &apos;Max texture resolution:&apos;,
      renderer.capabilities.maxTextureSize,
    );

    const maxPrecision = renderer.capabilities.getMaxPrecision();
    if (maxPrecision !== &apos;highp&apos;) {
      console.warn(
        `Shader maximum precision is &quot;${maxPrecision}&quot;, GPU rendering may not be accurate.`,
      );
    }

    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(
      this._simulationElt.offsetWidth,
      this._simulationElt.offsetHeight,
    );

    this._simulationElt.appendChild(renderer.domElement);

    this._renderer = renderer;
  }

  /**
   * @private
   */
  initPasses() {
    //const smaaEffect = new SMAAEffect(assets.get(&quot;smaa-search&quot;), assets.get(&quot;smaa-area&quot;));
    //smaaEffect.colorEdgesMaterial.setEdgeDetectionThreshold(0.065);

    const camera = this._camera.get3jsCamera();

    /*
    const sunGeometry = new THREE.SphereBufferGeometry(
      rescaleNumber(0.004),
      16,
      16,
    );
    const sunMaterial = new THREE.MeshBasicMaterial({
      color: 0xffddaa,
      transparent: true,
      depthWrite: false,
      fog: false,
    });
    const sun = new THREE.Mesh(sunGeometry, sunMaterial);
    const rescaled = rescaleArray([0.1, 0.1, 0.0]);
    sun.position.set(rescaled[0], rescaled[1], rescaled[2]);
    sun.updateMatrix();
    sun.updateMatrixWorld();

    const godRaysEffect = new GodRaysEffect(camera, sun, {
      color: 0xfff5f2,
      blur: false,
    });
    */
    //godRaysEffect.dithering = true;

    const bloomEffect = new BloomEffect(this._scene, camera, {
      width: 240,
      height: 240,
      luminanceThreshold: 0.2,
    });
    bloomEffect.inverted = true;
    bloomEffect.blendMode.opacity.value = 2.3;

    const renderPass = new RenderPass(this._scene, camera);
    renderPass.renderToScreen = false;

    const effectPass = new EffectPass(
      camera,
      /*smaaEffect, godRaysEffect*/ bloomEffect,
    );
    effectPass.renderToScreen = true;

    const composer = new EffectComposer(this._renderer);
    composer.addPass(renderPass);
    composer.addPass(effectPass);
    this._composer = composer;
  }

  /**
   * @private
   */
  update() {
    for (const objId in this._subscribedObjects) {
      if (this._subscribedObjects.hasOwnProperty(objId)) {
        this._subscribedObjects[objId].update(this._jd);
      }
    }
  }

  /**
   * @private
   * TODO(ian): Move this into Camera
   */
  doCameraDrift() {
    // Follow floating path around
    const timer = 0.0001 * Date.now();
    const pos = this._cameraDefaultPos;
    const cam = this._camera.get3jsCamera();
    cam.position.x = pos[0] + (pos[0] * (Math.cos(timer) + 1)) / 3;
    cam.position.z = pos[2] + (pos[2] * (Math.sin(timer) + 1)) / 3;
  }

  /**
   * @private
   */
  animate() {
    if (!this._renderEnabled) {
      return;
    }

    window.requestAnimationFrame(this.animate);

    if (this._stats) {
      this._stats.begin();
    }

    if (!this._isPaused) {
      if (this._jdDelta) {
        this._jd += this._jdDelta;
      } else {
        // N jd per second
        this._jd += this._jdPerSecond / this._fps;
      }

      const timeDelta = (Date.now() - this._lastUpdatedTime) / 1000;
      this._lastUpdatedTime = Date.now();
      this._fps = 1 / timeDelta || 1;

      // Update objects in this simulation
      this.update();
    }

    // Update camera drifting, if applicable
    if (this._enableCameraDrift) {
      this.doCameraDrift();
    }
    this._camera.update();

    // Update three.js scene
    this._renderer.render(this._scene, this._camera.get3jsCamera());
    //this._composer.render(0.1);

    if (this.onTick) {
      this.onTick();
    }

    if (this._stats) {
      this._stats.end();
    }
  }

  /**
   * Add a spacekit object (usually a SpaceObject) to the visualization.
   * @see SpaceObject
   * @param {Object} obj Object to add to visualization
   * @param {boolean} noUpdate Set to true if object does not need to be
   * animated.
   */
  addObject(obj, noUpdate = false) {
    obj.get3jsObjects().map(x =&gt; {
      this._scene.add(x);
    });

    if (!noUpdate) {
      // Call for updates as time passes.
      this._subscribedObjects[obj.getId()] = obj;
    }
  }

  /**
   * Removes an object from the visualization.
   * @param {Object} obj Object to remove
   */
  removeObject(obj) {
    // TODO(ian): test this and avoid memory leaks...
    obj.get3jsObjects().map(x =&gt; {
      this._scene.remove(x);
    });

    delete this._subscribedObjects[obj.getId()];
  }

  /**
   * Shortcut for creating a new SpaceObject belonging to this visualization.
   * Takes any SpaceObject arguments.
   * @see SpaceObject
   */
  createObject(...args) {
    return new SpaceObject(...args, this);
  }

  /**
   * Shortcut for creating a new ShapeObject belonging to this visualization.
   * Takes any ShapeObject arguments.
   * @see ShapeObject
   */
  createShape(...args) {
    return new ShapeObject(...args, this);
  }

  /**
   * Shortcut for creating a new SphereOjbect belonging to this visualization.
   * Takes any SphereObject arguments.
   * @see SphereObject
   */
  createSphere(...args) {
    return new SphereObject(...args, this);
  }

  /**
   * Shortcut for creating a new StaticParticles object belonging to this visualization.
   * Takes any StaticParticles arguments.
   * @see SphereObject
   */
  createStaticParticles(...args) {
    return new StaticParticles(...args, this);
  }

  /**
   * Shortcut for creating a new Skybox belonging to this visualization. Takes
   * any Skybox arguments.
   * @see Skybox
   */
  createSkybox(...args) {
    return new Skybox(...args, this);
  }

  /**
   * Shortcut for creating a new Stars object belonging to this visualization.
   * Takes any Stars arguments.
   * @see Stars
   */
  createStars(...args) {
    if (args.length) {
      return new Stars(...args, this);
    }
    // No arguments supplied
    return new Stars({}, this);
  }

  /**
   * Creates an ambient light source. This will dimly light everything in the
   * visualization.
   * @param {Number} color Color of light, default 0x333333
   */
  createAmbientLight(color = 0x333333) {
    this._scene.add(new THREE.AmbientLight(color));
    this._isUsingLightSources = true;
  }

  /**
   * Creates a light source. This will make the shape of your objects visible
   * and provide some contrast.
   * @param {Array.&lt;Number&gt;} pos Position of light source. Defaults to moving
   * with camera.
   * @param {Number} color Color of light, default 0xFFFFFF
   */
  createLight(pos = undefined, color = 0xffffff) {
    if (this._lightPosition) {
      console.warn(
        &quot;Spacekit doesn&apos;t support more than one light source for SphereObjects&quot;,
      );
    }
    this._lightPosition = new THREE.Vector3();

    // Pointlight is for standard meshes created by ShapeObjects.
    // TODO(ian): Remove this point light.
    const pointLight = new THREE.PointLight();

    if (typeof pos !== &apos;undefined&apos;) {
      const rescaled = rescaleArray(pos);
      this._lightPosition.set(rescaled[0], rescaled[1], rescaled[2]);
      pointLight.position.set(rescaled[0], rescaled[1], rescaled[2]);
    } else {
      // The light comes from the camera.
      // FIXME(ian): This only affects the point source.
      this._camera.get3jsCameraControls().addEventListener(&apos;change&apos;, () =&gt; {
        this._lightPosition.copy(this._camera.get3jsCamera().position);
        pointLight.position.copy(this._camera.get3jsCamera().position);
      });
    }

    this._scene.add(pointLight);
    this._isUsingLightSources = true;
  }

  getLightPosition() {
    return this._lightPosition;
  }

  isUsingLightSources() {
    return this._isUsingLightSources;
  }

  /**
   * Returns a promise that receives a NaturalSatellites object when it is
   * resolved.  @return {Promise&lt;NaturalSatellites&gt;} NaturalSatellites object
   * that is ready to load.
   *
   * @see {NaturalSatellites}
   */
  loadNaturalSatellites() {
    return new NaturalSatellites(this).load();
  }

  /**
   * Installs a scroll handler that only renders the visualization while it is
   * in the user&apos;s viewport.
   *
   * The scroll handler currently binds to the window object only.
   */
  renderOnlyInViewport() {
    let previouslyInView = true;
    const isInView = () =&gt; {
      const rect = this._simulationElt.getBoundingClientRect();
      const windowHeight =
        window.innerHeight || document.documentElement.clientHeight;
      const windowWidth =
        window.innerWidth || document.documentElement.clientWidth;
      const vertInView =
        rect.top &lt;= windowHeight &amp;&amp; rect.top + rect.height &gt;= 0;
      const horInView = rect.left &lt;= windowWidth &amp;&amp; rect.left + rect.width &gt;= 0;

      return vertInView &amp;&amp; horInView;
    };

    window.addEventListener(&apos;scroll&apos;, () =&gt; {
      const inView = isInView();
      if (previouslyInView &amp;&amp; !inView) {
        // Went out of view
        this._renderEnabled = false;
        previouslyInView = false;
      } else if (!previouslyInView &amp;&amp; inView) {
        // Came into view
        this._renderEnabled = true;
        window.requestAnimationFrame(this.animate);
        previouslyInView = true;
      }
    });

    if (!isInView()) {
      // Initial state is render enabled, so disable it if currently out of
      // view.
      this._renderEnabled = false;
      previouslyInView = false;
    }
  }

  /**
   * Adjust camera position so that the object fits within the viewport. If
   * applicable, this function will fit around the object&apos;s orbit.
   * @param {SpaceObject} spaceObj Object to fit within viewport.
   * @param {Number} offset Add some extra room in the viewport. Increase to be
   * further zoomed out, decrease to be closer. Default 3.0.
   */
  zoomToFit(spaceObj, offset = 3.0) {
    const checkZoomFit = () =&gt; {
      const orbit = spaceObj.getOrbit();
      const obj = orbit ? orbit.getOrbitShape() : spaceObj.getBoundingObject();
      if (obj) {
        this.doZoomToFit(obj, offset);
        return true;
      }
      return false;
    };

    // Wait until the object has been fully created.
    const bePatient = () =&gt; {
      if (!checkZoomFit()) {
        setTimeout(() =&gt; {
          bePatient();
        }, 100);
      }
    };
    bePatient();
  }

  /**
   * @private
   * Perform the actual zoom to fit behavior.
   * @param {SpaceObject} obj Object to fit within viewport.
   * @param {Number} offset Add some extra room in the viewport. Increase to be
   * further zoomed out, decrease to be closer. Default 3.0.
   */
  doZoomToFit(obj, offset) {
    const boundingBox = new THREE.Box3();
    boundingBox.setFromObject(obj);

    const center = new THREE.Vector3();
    boundingBox.getCenter(center);
    const size = new THREE.Vector3();
    boundingBox.getSize(size);

    // Get the max side of the bounding box (fits to width OR height as needed)
    const camera = this._camera.get3jsCamera();
    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    const cameraZ = Math.abs((maxDim / 2) * Math.tan(fov * 2)) * offset;

    const objectWorldPosition = new THREE.Vector3();
    obj.getWorldPosition(objectWorldPosition);
    const directionVector = camera.position.sub(objectWorldPosition); // Get vector from camera to object
    const unitDirectionVector = directionVector.normalize(); // Convert to unit vector

    const newpos = unitDirectionVector.multiplyScalar(cameraZ);
    camera.position.x = newpos.x;
    camera.position.y = newpos.y;
    camera.position.z = newpos.z;
    camera.updateProjectionMatrix();

    // Update default camera pos so if drift is on, camera will drift around
    // its new position.
    this._cameraDefaultPos = [newpos.x, newpos.y, newpos.z];
  }

  /**
   * Run the animation
   */
  start() {
    this._lastUpdatedTime = Date.now();
    this._isPaused = false;
  }

  /**
   * Stop the animation
   */
  stop() {
    this._isPaused = true;
  }

  /**
   * Gets the current JD date of the simulation
   * @return {Number} JD date
   */
  getJd() {
    return this._jd;
  }

  /**
   * Sets the JD date of the simulation.
   * @param {Number} val JD date
   */
  setJd(val) {
    this._jd = val;
  }

  /**
   * Get a date object representing local date and time of the simulation.
   * @return {Date} Date of simulation
   */
  getDate() {
    return julian.toDate(this._jd);
  }

  /**
   * Set the local date and time of the simulation.
   * @param {Date} date Date of simulation
   */
  setDate(date) {
    this.setJd(Number(julian(date)));
  }

  /**
   * Get the JD per frame of the visualization.
   */
  getJdDelta() {
    if (!this._jdDelta) {
      return this._jdPerSecond / this._fps;
    }
    return this._jdDelta;
  }

  /**
   * Set the JD per frame of the visualization. This will override any
   * existing &quot;JD per second&quot; setting.
   * @param {Number} delta JD per frame
   */
  setJdDelta(delta) {
    this._jdDelta = delta;
  }

  /**
   * Get the JD change per second of the visualization.
   * @return {Number} JD per second
   */
  getJdPerSecond() {
    if (this._jdDelta) {
      // Jd per second can vary
      return undefined;
    }
    return this._jdPerSecond;
  }

  /**
   * Set the JD change per second of the visualization.
   * @return {Number} x JD per second
   */
  setJdPerSecond(x) {
    // Delta overrides jd per second, so unset it.
    this._jdDelta = undefined;

    this._jdPerSecond = x;
  }

  /**
   * Get an object that contains useful context for this visualization
   * @return {Object} Context object
   */
  getContext() {
    return {
      simulation: this,
      options: this._options,
      objects: {
        particles: this._particles,
        camera: this._camera,
      },
      container: {
        width: this._simulationElt.offsetWidth,
        height: this._simulationElt.offsetHeight,
      },
    };
  }

  /**
   * Get the element containing this simulation
   * @return {HTMLElement} The html container of this simulation
   */
  getSimulationElement() {
    return this._simulationElt;
  }

  /**
   * Get the Camera and CameraControls wrapper object
   * @return {Camera} The Camera wrapper
   */
  getViewer() {
    return this._camera;
  }

  /**
   * Get the three.js scene object
   * @return {THREE.Scene} The THREE.js scene object
   */
  getScene() {
    return this._scene;
  }

  /**
   * Enable or disable camera drift.
   * @param {boolean} driftOn True if you want the camera to float around a bit
   */
  setCameraDrift(driftOn) {
    this._enableCameraDrift = driftOn;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
